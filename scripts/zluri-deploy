#!/usr/bin/env bash
set -euo pipefail

REPO="ZluriHQ/centralized-deployment"
WORKFLOW_FILE="deploy-feature-env.yaml"
CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/deploy-feature-env.conf"

AVAILABLE_REPOS=(
  "workflow-service"
  "v1-dashboard"
  "dashboard-api"
  "zluri-n8n"
  "integrations-v1"
  "bull-scheduler"
  "Integration-queue-consumer"
  "workflows-lambda"
  "agenda-project"
  "all"
)

# --- Dependency check for sk and gh ---
if ! command -v gh >/dev/null 2>&1; then
  echo "❌ GitHub CLI not found. Install via Homebrew: brew install gh"
  exit 1
fi

if ! command -v sk >/dev/null 2>&1; then
  echo "❌ skim (sk) not found. Install via Homebrew: brew install skim"
  exit 1
fi

# --- Auth check ---
if ! gh auth status >/dev/null 2>&1; then
  echo "❌ GitHub CLI not authenticated. Trying to authenticate"
  gh auth login
  exit 1
fi

# --- Load last saved config ---
LAST_BRANCH=""
LAST_REPOS=""
if [[ -f "$CONFIG_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$CONFIG_FILE"
fi

echo "======================================================="
echo " Select repos to deploy (TAB to multi-select, ENTER to confirm)"
echo "======================================================="

CHOICE_LIST=$(printf "%s\n" "${AVAILABLE_REPOS[@]}")
PRESELECT_ITEMS=$(echo "$LAST_REPOS" | tr ',' '\n')

# --- Repo selection using sk ---
CHOICES=$(echo "$CHOICE_LIST" | sk --multi --bind "tab:toggle+down" --pre-select-items "$PRESELECT_ITEMS")

if [[ -z "$CHOICES" ]]; then
  echo "❌ No repos selected. Exiting."
  exit 1
fi

if echo "$CHOICES" | grep -q "^all$"; then
  SELECTED_REPOS="all"
else
  SELECTED_REPOS=$(echo "$CHOICES" | paste -sd "," -)
fi

# --- Branch input ---
read -rp "Enter feature branch name (branch_name) [${LAST_BRANCH:-}]: " BRANCH_NAME
BRANCH_NAME="${BRANCH_NAME:-$LAST_BRANCH}"

if [[ -z "$BRANCH_NAME" ]]; then
  echo "❌ branch_name is required"
  exit 1
fi

# --- Save config ---
mkdir -p "$(dirname "$CONFIG_FILE")"
cat > "$CONFIG_FILE" <<EOF
LAST_BRANCH="$BRANCH_NAME"
LAST_REPOS="$SELECTED_REPOS"
EOF

# --- Trigger GitHub workflow ---
echo ""
echo "🚀 Triggering workflow..."
echo "  Repo:          $REPO"
echo "  Workflow file: $WORKFLOW_FILE"
echo "  branch_name:   $BRANCH_NAME"
echo "  repo_names:    $SELECTED_REPOS"
echo ""

gh workflow run "$WORKFLOW_FILE" \
  --repo "$REPO" \
  --ref feature/create-env-config \
  --field branch_name="$BRANCH_NAME" \
  --field repo_names="$SELECTED_REPOS"
