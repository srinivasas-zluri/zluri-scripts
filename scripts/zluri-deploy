#!/usr/bin/env bash
set -euo pipefail

# Check for help flags
if [[ "${1:-}" == "help" || "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    echo "Zluri Deploy - Feature Environment Deployment Tool"
    echo ""
    echo "DESCRIPTION:"
    echo "  This tool triggers feature environment deployments for Zluri repositories."
    echo "  It uses GitHub Actions to deploy multiple repositories with the same branch name."
    echo ""
    echo "IMPORTANT:"
    echo "  ðŸ”‘ Keep the branch name consistent across ALL selected repositories"
    echo "  ðŸ“‹ All repos will be deployed using the same branch_name parameter"
    echo "  ðŸŽ¯ This ensures coordinated deployments across the entire stack"
    echo ""
    echo "WORKFLOW:"
    echo "  1. Select repositories to deploy (multi-select with TAB)"
    echo "  2. Enter the feature branch name (must exist in all selected repos)"
    echo "  3. Tool triggers GitHub Actions workflow automatically"
    echo ""
    echo "AVAILABLE REPOSITORIES:"
    echo "  â€¢ workflow-service"
    echo "  â€¢ v1-dashboard"
    echo "  â€¢ dashboard-api"
    echo "  â€¢ zluri-n8n"
    echo "  â€¢ integrations-v1"
    echo "  â€¢ bull-scheduler"
    echo "  â€¢ Integration-queue-consumer"
    echo "  â€¢ workflows-lambda"
    echo "  â€¢ agenda-project"
    echo "  â€¢ all (deploys all repositories)"
    echo ""
    echo "CONFIGURATION:"
    echo "  â€¢ Last used branch and repos are saved in: ~/.config/deploy-feature-env.conf"
    echo "  â€¢ Previous selections are pre-selected for convenience"
    echo ""
    echo "DEPENDENCIES:"
    echo "  â€¢ GitHub CLI (gh) - for triggering workflows"
    echo "  â€¢ skim (sk) - for interactive selection"
    echo ""
    echo "GITHUB ACTIONS WORKFLOW:"
    echo "  ðŸ”— https://github.com/ZluriHQ/centralized-deployment/actions/workflows/deploy-feature-env.yaml"
    echo ""
    echo "EXAMPLES:"
    echo "  zluri deploy           # Interactive deployment"
    echo "  zluri deploy help     # Show this help"
    echo ""
    echo "TIPS:"
    echo "  â€¢ Use TAB to multi-select repositories"
    echo "  â€¢ Press ENTER to confirm your selection"
    echo "  â€¢ Ensure the branch exists in all selected repositories"
    echo "  â€¢ Check the GitHub Actions page for deployment status"
    exit 0
fi

REPO="ZluriHQ/centralized-deployment"
WORKFLOW_FILE="deploy-feature-env.yaml"
CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/deploy-feature-env.conf"

AVAILABLE_REPOS=(
  "workflow-service"
  "v1-dashboard"
  "dashboard-api"
  "zluri-n8n"
  "integrations-v1"
  "bull-scheduler"
  "Integration-queue-consumer"
  "workflows-lambda"
  "agenda-project"
  "all"
)

# --- Dependency check for sk and gh ---
if ! command -v gh >/dev/null 2>&1; then
  echo "âŒ GitHub CLI not found. Install via Homebrew: brew install gh"
  exit 1
fi

if ! command -v sk >/dev/null 2>&1; then
  echo "âŒ skim (sk) not found. Install via Homebrew: brew install skim"
  exit 1
fi

# --- Auth check ---
if ! gh auth status >/dev/null 2>&1; then
  echo "âŒ GitHub CLI not authenticated. Trying to authenticate"
  gh auth login
  exit 1
fi

# --- Load last saved config ---
LAST_BRANCH=""
LAST_REPOS=""
if [[ -f "$CONFIG_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$CONFIG_FILE"
fi

echo "======================================================="
echo " Select repos to deploy (TAB to multi-select, ENTER to confirm)"
echo "======================================================="

CHOICE_LIST=$(printf "%s\n" "${AVAILABLE_REPOS[@]}")
PRESELECT_ITEMS=$(echo "$LAST_REPOS" | tr ',' '\n')

# --- Repo selection using sk ---
CHOICES=$(echo "$CHOICE_LIST" | sk --multi --bind "tab:toggle+down" --pre-select-items "$PRESELECT_ITEMS")

if [[ -z "$CHOICES" ]]; then
  echo "âŒ No repos selected. Exiting."
  exit 1
fi

if echo "$CHOICES" | grep -q "^all$"; then
  SELECTED_REPOS="all"
else
  SELECTED_REPOS=$(echo "$CHOICES" | paste -sd "," -)
fi

# --- Branch input ---
read -rp "Enter feature branch name (branch_name) [${LAST_BRANCH:-}]: " BRANCH_NAME
BRANCH_NAME="${BRANCH_NAME:-$LAST_BRANCH}"

if [[ -z "$BRANCH_NAME" ]]; then
  echo "âŒ branch_name is required"
  exit 1
fi

# --- Save config ---
mkdir -p "$(dirname "$CONFIG_FILE")"
cat > "$CONFIG_FILE" <<EOF
LAST_BRANCH="$BRANCH_NAME"
LAST_REPOS="$SELECTED_REPOS"
EOF

# --- Trigger GitHub workflow ---
echo ""
echo "ðŸš€ Triggering workflow..."
echo "  Repo:          $REPO"
echo "  Workflow file: $WORKFLOW_FILE"
echo "  branch_name:   $BRANCH_NAME"
echo "  repo_names:    $SELECTED_REPOS"
echo ""

gh workflow run "$WORKFLOW_FILE" \
  --repo "$REPO" \
  --ref feature/create-env-config \
  --field branch_name="$BRANCH_NAME" \
  --field repo_names="$SELECTED_REPOS"
